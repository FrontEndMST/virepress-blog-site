# 异步传染

异步改为同步写法

React中的运用：Suspense，ErrorBoundary

```js
function getName() {
  return new Promise((resolve, reject) => {
    setTimeout(resolve, 3000, "luowei");
  });
}

function main() {
  const [name, err] = getName();
  if (!err) {
    console.log(name);
  } else {
    console.log(err);
  }
}

function run(func) {
  const cache = [];
  let index = 0;
  const _originGetName = getName;
  getName = () => {
    if (cache[index]) {
      if (cache[index].status === "fulfilled") {
        return [cache[index].data, cache[index].err];
      }
      if (cache[index].status === "rejected") {
        return [cache[index].data, cache[index].err];
      }
    }
    const result = {
      status: "pending",
      data: null,
      err: null,
    };
    cache[index++] = result;
    throw _originGetName().then(
      (value) => {
        result.status = "fulfilled";
        result.data = value;
      },
      (reason) => {
        result.status = "rejected";
        result.err = reason;
      }
    );
  };

  try {
    func();
  } catch (error) {
    if (error instanceof Promise) {
      const retry = () => {
        index = 0;
        func();
      };
      error.finally(retry);
    }
  }
}

run(main);
```

参考文章：

[React 18 新特性（二）：Suspense & SuspenseList - 掘金 (juejin.cn)](https://juejin.cn/post/6994674140825272334#heading-4)
